---
title: Rock and Roll Sub-Genres
shorttitle: Rock & Roll Sub-Genres
author:
- name: Jack Stapholz
  affiliation: University of California - Los Angeles
  email: jstapholz\@ucla.edu
  # thanks: other info
output: rticles::jasa_article
abstract: |
  Any sort of music genre can be further divided into countless niche sub-genres. However, the more we partition these genres, the aspects that characterize each sub-genre becomes unclear. Using text mining and analysis, we can precisely define what defines a song of a given sub-genre and even classify which sub-genre a given song belongs to. In this study, we will copmile the lyrics to songs in multiple sub-genres of rock and roll music and tokenize the terms for analysis. 
  
# The following prints the current date (optional, set to false to remove).
date: true
classoption:
  - preprint # Set to "reprint" to use the reprint style.
# The reprint style typesets the manuscript with two columns and 10pt font size.  
#  - NumberedRefs # Uncomment to use numbered references rather than the default author-year style.
#  - trackchanges # Uncomment to track changes in the manuscript. (Use with preprint option).
#  - 12pt # Uncomment this to check if you exceeded the 12 page limit. (Use with reprint option).
#  - TurnOnLineNumbers # Uncomment to add line numbers in reprint. (Use with reprint.)

# When using the preprint style, use the following to add a notice on the first page (optional).
preprint_notice: "Jack Stapholz, UCLA"
bibliography: sampbib.bib

# The Author-Year style is the default. If you want to use the numeric style,
# use "jasanum2.bst" instead.
biblio-style: jasaauthyear2.bst
---

```{r setup, include=FALSE}
# Use fig.process to rename figure files generated by R so that they comply with
# the journal naming policies. Remember to name plot chunks with the format
# "Figure1", "Figure2", etc... You will find the figure files in
# `[...]_files/figure-latex/`.

knitr::opts_chunk$set(
  echo = TRUE,
  out.width="\\reprintcolumnwidth",
  fig.process = function(x) {
    x2 = sub('-\\d+([.][a-z]+)$', '\\1', x)
    if (file.rename(x, x2)) x2 else x
  }
)

# The JASA LaTeX class depends on the LaTeX package "revtex4-1". If you are
# using a full LaTeX distro, you should make sure "revtex4-1" is installed, and
# install it if not. If you are using TinyTeX, the following code will take care
# of installing the package for you.

if (tinytex::is_tinytex() && !tinytex::check_installed('revtex4-1')) {
  tinytex::tlmgr_install("revtex4-1")
}

library(quanteda)
library(text2vec)
library(tidytext)
library(stringr)
library(tidyr)
library(spacyr)
spacy_install()
spacy_initialize()
library(tm)
library(readtext)
library(rjson)
library(shiny)
library(pdftools)
library(RSQLite)
library(SnowballC) # text stemming library
library(wordcloud) # for making wordcloud visualizations
library(wordcloud2)
library(syuzhet) # text sentiment analysis
library(ggplot2) # one of the best data visualization libraries
library(qdap) # Quantitative discourse analysis of transcripts
library(qdapDictionaries) 
library(dplyr) # Data preparation and pipes
library(RColorBrewer) # Generate palette of colors for plots
library(scales) # Include commas in numbers.
library(Rgraphviz) # Correlation
library(textdata)
library(geniusr)
library(spotifyr)
library(readtext)
library(gridExtra)
library(formatR)
library(htmlwidgets)
library(webshot)
library(htmltools)
library(forcats)
library(text2vec)
library(topicmodels)

Sys.setenv(SPOTIFY_CLIENT_ID = 'f9f79296d3f942ebba503bddf3cc5011')
Sys.setenv(SPOTIFY_CLIENT_SECRET = 'bd61360a01e5493ba6a1ed93533c7895')

access_token <- get_spotify_access_token()

markdown_widget <- function(widget,path=getwd(),filename="file.png"){
  require(htmlwidgets)
  require(webshot)
  saveWidget(widget,"tmp.html",selfcontained = F)
  file <- paste(path,filename,sep = "/")
  webshot("tmp.html",file,delay = 5,vwidth = 1024,vheight = 768)
  file.remove("tmp.html")
  paste0("![",file,"](",file,")\n\n") %>% cat()
}

require(knitr)
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 80), tidy = TRUE)
#knitr::opts_chunk$set(fig.height = 9, fig.width = 7)
#knitr::opts_chunk$set(out.height = "\\textheight",  out.width = "\\textwidth")
knitr::opts_chunk$set(out.width = "\\textwidth")

hook_output = knit_hooks$get('output')
knit_hooks$set(output = function(x, options) {
  if (!is.null(n <- 80)) {
    x = xfun::split_lines(x)
    if (any(nchar(x) > n)) x = strwrap(x, width = n)
    x = paste(x, collapse = '\n')
  }
  hook_output(x, options)
})
```


# Introduction


## Motivation

The motivation of this research project is to explore various rock and roll sub-genres, and how they are similar to each other. It is also of interest to be able to tell if a certain artist has unique lyrics, allowing us to predict who the artist is through the lyrics of their songs.

## Research Problem

In order to narrow down our sample size, we're going to take a look at rock bands with a popularity score of 4 or higher. Artists are going to be one of a few from various sub-genres, such as '90s grunge, classic rock, and heavy metal. After building a corpus from our lyric data, we can clean up the text and tokenize. Using our tokenized words, we can then analyze sentiments and identify frequent and infrequent terms. One of the more important aspects in this project is modeling the topics through the lyrics of each band's songs. This will allow us to differentiate the aspects of each sub genre and uniqueness of individual artists. Based on the predictive ability of the lyrics of rock and roll sub-genres, we can determine how unique each one is from each other. Music data was derived from a dataset posted on Kaggle [@musicdataset].

## Expected Outcome

The expected outcome of this research project is that specific sub-genres will have similar characteristics (sentiments, word choices, complexity, etc.). Even further, artists within these sub-genres will differentiate themselves from the other artists.


# Introduction to the Data

```{R Importing Data, message=FALSE, warning=FALSE, include=FALSE}
artists <- read.csv(file = "../../Data/artists-data.csv", stringsAsFactors = FALSE)
music <- read.csv(file = "../../Data/lyrics-data.csv", stringsAsFactors = FALSE)

lyrics.full <- left_join(music, artists, by = c("ALink"))  # Starting point (full data set)
lyrics.full <- lyrics.full %>% filter(language == "en")
lyrics.full <- lyrics.full %>% filter(Popularity >= 4)
lyrics.full <- lyrics.full %>% filter(grepl(c('Rock|Metal'), Genres))
colOrder <- c("SName", "Artist", "Genres", "Popularity", "language", "Songs", "Lyric", "SLink", "ALink")
lyrics.full <- lyrics.full[, colOrder]
write.csv(lyrics.full, file = "../../Data/music_data.csv", row.names = FALSE)
```

## Data Selection

```{R Data Selection, include=FALSE}
lyrics.selectedArtists <- c("Alice In Chains", "Nirvana", "Pearl Jam", "Bon Jovi", "Johnny Cash", "Queen", "Rolling Stones", "Metallica", "Slipknot", "Iron Maiden")

lyrics <- lyrics.full %>% filter(Artist %in% lyrics.selectedArtists)
write.csv(lyrics, file = "../../Data/selected_music_data.csv", row.names = FALSE)
write.csv(lyrics$Lyric, file = "../../Data/selected_music_lyrics.csv", row.names = FALSE)
write.csv(lyrics$Lyric[lyrics$Artist %in% lyrics.selectedArtists[1:3]], file = "../../Data/grunge_lyrics.csv", row.names = FALSE)
write.csv(lyrics$Lyric[lyrics$Artist %in% lyrics.selectedArtists[4:7]], file = "../../Data/classic_lyrics.csv", row.names = FALSE)
write.csv(lyrics$Lyric[lyrics$Artist %in% lyrics.selectedArtists[8:10]], file = "../../Data/metal_lyrics.csv", row.names = FALSE)
```

In order to reduce complexity of the study and allow for limitations in computing power, we will take a look at 3-4 artists from each sub-genre. From the '90s grunge sub-genre, we are analyzing Alice in Chains, Nirvana, and Pearl Jam. Classic Rock bands in this study include Bon Jovi, Johnny Cash, Queen, and the Rolling Stones. Metallica, Slipknot, and Iron Maiden are the metal bands that are being studied.

## Previewing the data

```{R Dimensions and Head, echo=FALSE}
dim(lyrics)
head(lyrics[, -7], 1)
```

Our lyrics data has 2,524 rows (each corresponding to a song) and 9 columns. Along with lyric data, each song comes with a song name, artist name, list of genre tags, popularity score, language, and total number of songs belonging to the artist.


# Processing the Data

## Building the Corpus

```{R Building Corpus, echo=FALSE}
lyrics.corpus <- VCorpus(VectorSource(lyrics$Lyric))

meta(lyrics.corpus, type = "local", tag = "SName") <- lyrics$SName
meta(lyrics.corpus, type = "local", tag = "Artist") <- lyrics$Artist
meta(lyrics.corpus, type = "local", tag = "Genres") <- lyrics$Genres
meta(lyrics.corpus, type = "local", tag = "Popularity") <- lyrics$Popularity
meta(lyrics.corpus, type = "local", tag = "language") <- lyrics$language
meta(lyrics.corpus, type = "local", tag = "Songs") <- lyrics$Songs
meta(lyrics.corpus, type = "local", tag = "SLink") <- lyrics$SLink
meta(lyrics.corpus, type = "local", tag = "ALink") <- lyrics$ALink

# inspect(lyrics.corpus[1:3])
```

A corpus is constructed with each song as a document. Other information contained in the data set is stored in the corpus as metadata.

## Cleaning the Data

```{R include=FALSE}
toSpace <- content_transformer(function(x, pattern) gsub(pattern, " ", x))
toString <- content_transformer(function(x, from, to) gsub(from, to, x))
#lyrics.corpus <- tm_map(lyrics.corpus, toSpace, '[\n]')

lyrics.corpus.unclean <- lyrics.corpus

lyrics.removeWords <- c("INSTRUMENTAL", 
  "thismanipulationviolence", "mooooooooooooooooooooom", "laladadadadadadadadada",
  "letraphpidixzzwrwxenmd", "ahhhhhhhhhhhhhhhhhhhh", "cloneclonecloneclone", 
  "dodiedodiedodiedodie", "dodiedodiedodiedodie",  "fightfightfightfight",
  "im", "gonna", "ive", "ill", "yeah", "hey", "wanna", "youre",
  "rockstarcelebratedvictimofyourfame", "phpidixzzwrwxenmd", 
  "abebybickyoubygogogoyeah", "sonofgeorgyporgys", "ihavesinnedbyjust",
  "sonoftrickydickys", "orrrrrhhharhhhhhh", "hahahahahahahaha", "uh", "na",
  "a5", "c5", "ah", "0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "b5", 
  "d5", "ooh", "oooh", "aah", "aaah", "ta", "wo", "g5", "nc", "10", "12",
  "14", "15", "16", "17", "18", "19", "99", "x2", "eh", "e5",
  "ve", "82", "ac", "84", "b4", "ve", "a2", "iâ", "rhy", "da", "la", "ja")
```

```{R Data Cleaning, echo=FALSE}
# 1. Simple Transformations
lyrics.corpus <- tm_map(lyrics.corpus, toSpace, '[\n/|_@|,.\\|â€¦“”"]')

# 2. Conversion to Lowercase
lyrics.corpus <- tm_map(lyrics.corpus, content_transformer(tolower))

# 3. Remove Numbers
lyrics.corpus <- tm_map(lyrics.corpus, removeNumbers)

# 4. Remove Punctuation
lyrics.corpus <- tm_map(lyrics.corpus, removePunctuation)

# 5. Remove English Stop Words
lyrics.corpus <- tm_map(lyrics.corpus, removeWords, stopwords("english"))
  
# 6. Remove Specific Terms
lyrics.corpus <- tm_map(lyrics.corpus, removeWords, lyrics.removeWords)

# 7. Strip Whitespace
lyrics.corpus <- tm_map(lyrics.corpus, stripWhitespace)

# 8. Specific Transformations
lyrics.corpus <- tm_map(lyrics.corpus, toString, "[^[:alnum:]]", " ")

# inspect(lyrics.corpus[1:3])
```

Extensive steps are taken to clean the raw lyric data from the dataset. First, symbols such as quotation marks, currency symbols, and accented letters are removed. Then, all letters are transformed to lower case. Both numbers and remaining punctuation are removed, along with stop words. Whitespace is stripped, and other miscellaneous words such as "ahhhhhhhhhhhhhhhhhhhh" are removed.

## Tokenization

```{R Corpus by Genre, message=FALSE, warning=FALSE, include=FALSE}
grunge.indices <- numeric(0)
classic.indices <- numeric(0)
metal.indices <- numeric(0)
for (i in 1:dim(lyrics)[1]) {
  if (lyrics.corpus[[i]][["meta"]][["Artist"]] %in% lyrics.selectedArtists[1:3]) {
    grunge.indices <- c(grunge.indices, i)
  }
  else if (lyrics.corpus[[i]][["meta"]][["Artist"]] %in% lyrics.selectedArtists[4:7]) {
    classic.indices <- c(classic.indices, i)
  }
  else if (lyrics.corpus[[i]][["meta"]][["Artist"]] %in% lyrics.selectedArtists[8:10]) {
    metal.indices <- c(metal.indices, i)
  }
}

quanteda.lyrics.corpus <- corpus(lyrics.corpus)
grunge.corpus <- corpus(lyrics.corpus[grunge.indices])
classic.corpus <- corpus(lyrics.corpus[classic.indices])
metal.corpus <- corpus(lyrics.corpus[metal.indices])
```

```{R Tokenization, echo=FALSE, message=FALSE, warning=FALSE}
grunge.tokens <- tokens(grunge.corpus)
grunge.tokens <- as_tibble(unlist(grunge.tokens))
names(grunge.tokens) <- "word"
grunge.tokens <- grunge.tokens %>% anti_join(stop_words)
grunge.tokens.repeated <- grunge.tokens
grunge.tokens <- grunge.tokens %>% count(word) %>% arrange(desc(n))

classic.corpus <- corpus(lyrics.corpus[classic.indices])
classic.tokens <- tokens(classic.corpus)
classic.tokens <- as_tibble(unlist(classic.tokens))
names(classic.tokens) <- "word"
classic.tokens <- classic.tokens %>% anti_join(stop_words)
classic.tokens.repeated <- classic.tokens
classic.tokens <- classic.tokens %>% count(word) %>% arrange(desc(n))

metal.tokens <- tokens(metal.corpus)
metal.tokens <- as_tibble(unlist(metal.tokens))
names(metal.tokens) <- "word"
metal.tokens <- metal.tokens %>% anti_join(stop_words)
metal.tokens.repeated <- metal.tokens
metal.tokens <- metal.tokens %>% count(word) %>% arrange(desc(n))

lyrics.tokens.repeated <- grunge.tokens.repeated %>% mutate(genre = "grunge")
lyrics.tokens.repeated <- classic.tokens.repeated %>% mutate(genre = "classic rock") %>% rbind(lyrics.tokens.repeated)
lyrics.tokens.repeated <- metal.tokens.repeated %>% mutate(genre = "metal") %>% rbind(lyrics.tokens.repeated)
lyrics.tokens <- lyrics.tokens.repeated %>% count(word, genre, sort = TRUE)
lyrics.tokens <- lyrics.tokens %>% group_by(genre) %>% mutate(total = sum(n)) %>% ungroup()



lyrics.tidy <- tidytext::tidy(lyrics.corpus.unclean) %>% mutate(genre = "")
for (i in 1:dim(lyrics.tidy)[1]) {
  if (lyrics.tidy[i, "Artist"] %in% lyrics.selectedArtists[1:3]) {
    lyrics.tidy[i, "genre"] <- "grunge"
  }
  else if (lyrics.tidy[i, "Artist"] %in% lyrics.selectedArtists[4:7]) {
    lyrics.tidy[i, "genre"] <- "classic rock"
  }
  else if (lyrics.tidy[i, "Artist"] %in% lyrics.selectedArtists[8:10]) {
    lyrics.tidy[i, "genre"] <- "metal"
  }
}

lyrics.tidy.united <- lyrics.tidy  %>% unite(document, genre, SName)
lyrics.tidy.long <- lyrics.tidy %>% separate_longer_delim(text, "\n") %>% filter(text != "") %>% group_by(SName) %>% mutate(linenumber = row_number()) %>% ungroup()
lyrics.tidy.words <- lyrics.tidy.long %>% unnest_tokens(word, text, drop = FALSE) %>% count(genre, word, sort = TRUE) %>% anti_join(stop_words) %>% anti_join(tibble(word = c("yeah", "gonna", "0", "hey", "wanna")))
lyrics.tidy.words.united <- lyrics.tidy.united %>% unnest_tokens(word, text, drop = FALSE) %>% count(document, word, sort = TRUE) %>% anti_join(stop_words) %>% anti_join(tibble(word = lyrics.removeWords))
```

Lyrics are tokenized and categorized primarily based on genre.

## Term Document Matrix

The following output is a summary of term document matrices of each genre.

```{R Term Document Matrix, echo=FALSE}
lyrics.tdm <- TermDocumentMatrix(lyrics.corpus)
# lyrics.tdm
# lyrics.tdm$dimnames$Terms[lyrics.tdm$dimnames$Terms %>% nchar() %>% which.max()]

grunge.tdm <- TermDocumentMatrix(grunge.corpus)
grunge.tdm
grunge.tdm$dimnames$Terms[grunge.tdm$dimnames$Terms %>% nchar() %>% which.max()]

classic.tdm <- TermDocumentMatrix(classic.corpus)
classic.tdm
classic.tdm$dimnames$Terms[classic.tdm$dimnames$Terms %>% nchar() %>% which.max()]

metal.tdm <- TermDocumentMatrix(metal.corpus)
metal.tdm
metal.tdm$dimnames$Terms[metal.tdm$dimnames$Terms %>% nchar() %>% which.max()]
```

## Word Frequency

The following output of plots is a summary of the most frequent terms from each genre. The cutoffs for grunge, classic rock, and metal are n > 120, n > 600, and n > 225 respectively.

```{R Word Frequency by Genre, echo=FALSE}
#lyrics.tokens %>% filter(n > 500) %>% mutate(word = reorder(word, n)) %>% ggplot(aes(word, n, fill = n)) + geom_col() + xlab(NULL) + coord_flip()

grunge.tokens.plot <- grunge.tokens %>% filter(n > 120) %>% mutate(word = reorder(word, n)) %>% ggplot(aes(word, n, fill = n)) + geom_col() + xlab(NULL) + coord_flip() + ggtitle("Grunge Word Frequency")
classic.tokens.plot <- classic.tokens %>% filter(n > 600) %>% mutate(word = reorder(word, n)) %>% ggplot(aes(word, n, fill = n)) + geom_col() + xlab(NULL) + coord_flip() + ggtitle("Classic Rock Word Frequencies")
metal.tokens.plot <- metal.tokens %>% filter(n > 225) %>% mutate(word = reorder(word, n)) %>% ggplot(aes(word, n, fill = n)) + geom_col() + xlab(NULL) + coord_flip() + ggtitle("Metal Word Frequencies")

grid.arrange(grunge.tokens.plot, classic.tokens.plot, metal.tokens.plot, ncol = 2, top = "Word Frequency by Genre")
```

The tf-idf plots show the terms that are the most unique to each genre. Terms from grunge and classic rock genres are a combination of names and other unusual terms. Terms from the metal genre are characterized as exceptionally dark and vulgar.

```{R tf-idf, echo=FALSE}
lyrics.tfidf <- lyrics.tokens %>% bind_tf_idf(word, genre, n)
head(lyrics.tfidf, 3)

lyrics.tfidf <- lyrics.tfidf %>% select(-total) %>% arrange(desc(tf_idf))

lyrics.tfidf %>% group_by(genre) %>% slice_max(tf_idf, n = 15) %>% ungroup() %>% ggplot(aes(tf_idf, fct_reorder(word, tf_idf), fill = genre)) + geom_col(show.legend = FALSE) + facet_wrap(~genre, ncol = 2, scales = "free") + labs(x = "tf-idf", y = NULL)
```

Taking a look at individual terms, there is a large gap between the frequency in each genre. Negative words like die and kill are very common in metal, and positive words such as love and baby are most common in classic rock.

```{R Words Along Genre, echo=FALSE, message=FALSE, warning=FALSE}
lyrics.topic.wordCounts <- lyrics.tidy.words %>% ungroup() %>% group_by(genre) %>% mutate(genre_total = sum(n))

lyrics.topic.wordCounts %>% filter(word %in% c("time", "feel", "dream", "god", "love", "baby", "life", "die", "kill")) %>% ggplot(aes(genre, n / genre_total)) + geom_point() + geom_smooth() + facet_wrap(~word, scales = "free_y") + scale_y_continuous(labels = scales::percent_format()) + ylab("% frequency of word in genres")
```

## N-Grams

N-Grams, specifically bi-grams as visualized by the plots below, show strong connections between two words that provide a deeper insight into things discussed within song lyrics. Similar to the tf-idf plots, names are common bi-grams. Other bi-grams shown below typically come from a specific song and are repeated commonly in a specific song.

```{R NGram, echo=FALSE}
grunge.bigrams <- data.frame(text = unlist(strsplit(lyrics$Lyric[grunge.indices], "\n"))) %>% unnest_tokens(bigram, text, token = "ngrams", n = 2) %>% count(bigram, sort = TRUE) %>% separate(bigram, c("word1", "word2"), sep = " ")
grunge.bigrams <- grunge.bigrams[complete.cases(grunge.bigrams),]
grunge.bigrams.filtered <- grunge.bigrams %>% filter(!word1 %in% stop_words$word) %>% filter(!word2 %in% stop_words$word) %>% filter(!word1 %in% lyrics.removeWords) %>% filter(!word2 %in% lyrics.removeWords) %>% unite(bigram, word1, word2, sep = " ")

classic.bigrams <- data.frame(text = unlist(strsplit(lyrics$Lyric[classic.indices], "\n"))) %>% unnest_tokens(bigram, text, token = "ngrams", n = 2) %>% count(bigram, sort = TRUE) %>% separate(bigram, c("word1", "word2"), sep = " ")
classic.bigrams <- classic.bigrams[complete.cases(classic.bigrams),]
classic.bigrams.filtered <- classic.bigrams %>% filter(!word1 %in% stop_words$word) %>% filter(!word2 %in% stop_words$word) %>% filter(!word1 %in% lyrics.removeWords) %>% filter(!word2 %in% lyrics.removeWords) %>% unite(bigram, word1, word2, sep = " ")

metal.bigrams <- data.frame(text = unlist(strsplit(lyrics$Lyric[metal.indices], "\n"))) %>% unnest_tokens(bigram, text, token = "ngrams", n = 2) %>% count(bigram, sort = TRUE) %>% separate(bigram, c("word1", "word2"), sep = " ")
metal.bigrams <- metal.bigrams[complete.cases(metal.bigrams),]
metal.bigrams.filtered <- metal.bigrams %>% filter(!word1 %in% stop_words$word) %>% filter(!word2 %in% stop_words$word) %>% filter(!word1 %in% lyrics.removeWords) %>% filter(!word2 %in% lyrics.removeWords) %>% unite(bigram, word1, word2, sep = " ")

grunge.bigrams.plot <- grunge.bigrams.filtered %>% filter(n > 9) %>% mutate(bigram = reorder(bigram, n)) %>% ggplot(aes(bigram, n, fill = n)) + geom_col() + xlab(NULL) + ylab("Count") + coord_flip() + ylab("Grunge Bigrams")
classic.bigrams.plot <- classic.bigrams.filtered %>% filter(n > 30) %>% mutate(bigram = reorder(bigram, n)) %>% ggplot(aes(bigram, n, fill = n)) + geom_col() + xlab(NULL) + ylab("Count") + coord_flip() + ylab("Classic Rock Bigrams")
metal.bigrams.plot <- metal.bigrams.filtered %>% filter(n > 15) %>% mutate(bigram = reorder(bigram, n)) %>% ggplot(aes(bigram, n, fill = n)) + geom_col() + xlab(NULL) + ylab("Count") + coord_flip() + ylab("Metal Bigrams")

grid.arrange(grunge.bigrams.plot, classic.bigrams.plot, metal.bigrams.plot, ncol = 2)
```

## Text Visualization

```{R Wordcloud2s, echo=FALSE, message=FALSE}
grunge.wordcloud2 <- grunge.tokens %>% wordcloud2(shape = "star")
saveWidget(grunge.wordcloud2, "tmp.html", selfcontained = FALSE)
##webshot("tmp.html", "wc1.png", delay = 10)

classic.wordcloud2 <- classic.tokens %>% wordcloud2(shape = "cardioid")
saveWidget(classic.wordcloud2, "tmp2.html", selfcontained = FALSE)
##webshot("tmp2.html", "wc2.png", delay = 10)

metal.wordcloud2 <- metal.tokens %>% wordcloud2(shape = "pentagon")
saveWidget(metal.wordcloud2, "tmp3.html", selfcontained = FALSE)
##webshot("tmp3.html", "wc3.png", delay = 10)
```
```{r Figure4, echo=FALSE, fig.cap="Wordcloud2 of Grunge Words."}
knitr::include_graphics("wc1.png")
```
```{r Figure5, echo=FALSE, fig.cap="Wordcloud2 of Classic Rock Words."}
knitr::include_graphics("wc2.png")
```
```{r Figure6, echo=FALSE, fig.cap="Wordcloud2 of Metal Words."}
knitr::include_graphics("wc3.png")
Sys.sleep(2)
```


# Sentiment Analysis

Pie charts of positive vs. negative sentiments are insightful to determine the general mood of songs from the genres covered in this study. Grunge and classic rock songs are practically equal when it comes to positivity with a ratio of ~55/45 positive to negative. These graphs provide a great insight into how metal differs from other rock sub-genres, since it has a ratio of 63/37. This is strong evidence to suggest metal music is much more negative than other rock and roll songs.

```{R Positive/Negative Pie Charts, echo=FALSE, warning=FALSE}
grunge.nrc <- get_nrc_sentiment(grunge.tokens$word)
classic.nrc <- get_nrc_sentiment(classic.tokens$word)
metal.nrc <- get_nrc_sentiment(metal.tokens$word)


grunge.piechart <- data.frame(emotion = names(colSums(prop.table(classic.nrc[, 9:10]))), proportion = colSums(prop.table(grunge.nrc[, 9:10])))
grunge.piechart.plot <- ggplot(grunge.piechart, aes(x = "", y = proportion, fill = emotion)) + geom_bar(width = 1, stat = "identity") + coord_polar("y", start = 0) + scale_fill_brewer(palette = "Blues") + theme_minimal() + geom_text(aes(label = round(proportion, digits = 2)), position = position_stack(vjust = 0.5)) + xlab(NULL) + ylab("Grunge")

classic.piechart <- data.frame(emotion = names(colSums(prop.table(classic.nrc[, 9:10]))), proportion = colSums(prop.table(classic.nrc[, 9:10])))
classic.piechart.plot <- ggplot(classic.piechart, aes(x = "", y = proportion, fill = emotion)) + geom_bar(width = 1, stat = "identity") + coord_polar("y", start = 0) + scale_fill_brewer(palette = "Reds") + theme_minimal() + geom_text(aes(label = round(proportion, digits = 2)), position = position_stack(vjust = 0.5)) + xlab(NULL) + ylab("Classic")

metal.piechart <- data.frame(emotion = names(colSums(prop.table(metal.nrc[, 9:10]))), proportion = colSums(prop.table(metal.nrc[, 9:10])))
metal.piechart.plot <- ggplot(metal.piechart, aes(x = "", y = proportion, fill = emotion)) + geom_bar(width = 1, stat = "identity") + coord_polar("y", start = 0) + scale_fill_brewer(palette = "Greys") + theme_minimal() + geom_text(aes(label = round(proportion, digits = 2)), position = position_stack(vjust = 0.5)) + xlab(NULL) + ylab("Metal")

grid.arrange(grunge.piechart.plot, classic.piechart.plot, metal.piechart.plot, ncol = 2)
```

These graphs show the frequency of sentiments within the rock and roll sub-genres. Given a specific cut-off relative to the number of terms from each genre, each plot shows a larger variety of terms used to describe negative sentiments. However, only heavy metal music has a more frequent use of negative words compared to positive ones. This is another strong piece of evidence to show how exactly metal differentiates from grunge and classic rock.

```{R Sentiments, echo=FALSE, message=FALSE, warning=FALSE}
lyrics.bing <- lyrics.tidy.words %>% inner_join(get_sentiments("bing"))
grunge.bing.plot <- lyrics.bing %>% ungroup() %>% filter(n > 50) %>% filter(genre == "grunge") %>% mutate(n = ifelse(sentiment == "negative", -n, n)) %>% mutate(word = reorder(word, n)) %>% ggplot(aes(word, n, fill = sentiment)) + geom_bar(stat = "identity") + ylab("Grunge Sentiments (n > 50)") + coord_flip() + theme(plot.title = element_text(hjust = 0.5))
classic.bing.plot <- lyrics.bing %>% ungroup() %>% filter(n > 185) %>% filter(genre == "classic rock") %>% mutate(n = ifelse(sentiment == "negative", -n, n)) %>% mutate(word = reorder(word, n)) %>% ggplot(aes(word, n, fill = sentiment)) + geom_bar(stat = "identity") + ylab("Classic Rock Sentiments (n > 185)") + coord_flip() + theme(plot.title = element_text(hjust = 0.5))
metal.bing.plot <- lyrics.bing %>% ungroup() %>% filter(n > 90) %>% filter(genre == "metal") %>% mutate(n = ifelse(sentiment == "negative", -n, n)) %>% mutate(word = reorder(word, n)) %>% ggplot(aes(word, n, fill = sentiment)) + geom_bar(stat = "identity") + ylab("Metal Sentiments (n > 90)") + coord_flip() + theme(plot.title = element_text(hjust = 0.5))

grid.arrange(grunge.bing.plot, classic.bing.plot, metal.bing.plot, ncol = 2, top = "Bing Sentiments")
```


# Topic Modeling

Topic modeling from the music tokens provides evidence contrary to the claim that these sub-genres are different from each other. There is strong cross over in pretty much every topic in every genre. 

```{R Topic Modeling, echo=FALSE, message=FALSE, warning=FALSE}
lyrics.dtm <- lyrics.tidy.words.united %>% cast_dtm(document, word, n)
lyrics.lda <- LDA(lyrics.dtm, k = 3, control = list(seed = 1019))
lyrics.topics <- tidytext::tidy(lyrics.lda, matrix = "beta")
lyrics.topTerms <- lyrics.topics %>% group_by(topic) %>% top_n(4, beta) %>% ungroup() %>% arrange(topic, -beta)
lyrics.topTerms
lyrics.gamma <- tidytext::tidy(lyrics.lda, matrix = "gamma")
lyrics.gamma <- lyrics.gamma %>% separate(document, c("genre", "SName"), sep = "_", convert = TRUE)
# lyrics.gamma

lyrics.gamma %>% mutate(genre = reorder(genre, gamma * topic)) %>% ggplot(aes(factor(topic), gamma)) + geom_boxplot() + facet_wrap(~genre)
```

The following misclassification chart shows that there is immense crossover between topics discussed in metal and grunge music. However, classic rock differentiates itself from the other two genres in terms of topics. Classic rock is the genre most often misclassified.

```{R Topic Classification, echo=FALSE, message=FALSE, warning=FALSE}
lyrics.classification <- lyrics.gamma %>% group_by(genre, SName) %>% top_n(1, gamma) %>% ungroup()
lyrics.songTopics <- lyrics.classification %>% count(genre, topic) %>% group_by(genre) %>% top_n(1, n) %>% ungroup() %>% transmute(consensus = genre, topic)
lyrics.misclassification <- lyrics.classification %>% inner_join(lyrics.songTopics, by = "topic") %>% filter(genre != consensus)
sort(table(lyrics.misclassification$genre), decreasing = TRUE)[1]

lyrics.assignments <- augment(lyrics.lda, data = lyrics.dtm)
lyrics.assignments <- lyrics.assignments %>% separate(document, c("genre", "SName"), sep = "_", convert = TRUE) %>% inner_join(lyrics.songTopics, by = c(".topic" = "topic"))

lyrics.assignments %>% count(genre, consensus, wt = count) %>% group_by(genre) %>% mutate(percent = n / sum(n)) %>%
  ggplot(aes(consensus, genre, fill = percent)) + geom_tile() + scale_fill_gradient2(high = "red", label = percent_format()) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, hjust = 1), panel.grid = element_blank()) + labs(x = "Song words were assigned to", y = "Song words came from", fill = "% of assignments")

lyrics.wrongWords <- lyrics.assignments %>% filter(genre != consensus)
# head(lyrics.wrongWords %>% arrange(-count), 10)
```


# Comparing Artists

## Term Frequency

All of the grunge artists use a similar set of words at a similar frequency.

```{R Grunge Frequent Terms, echo=FALSE, message=FALSE, warning=FALSE}
artist.tokens.plot <- lyrics.tidy.long %>% unnest_tokens(word, text, drop = FALSE) %>% count(Artist, word, sort = TRUE) %>% anti_join(stop_words) %>% anti_join(tibble(word = c("yeah", "gonna", "0", "hey", "wanna", "2x", "5", "na", "whoo"))) %>% filter(Artist %in% lyrics.selectedArtists[1:3]) %>% group_by(Artist) %>% slice_max(n, n = 10) %>% mutate(word = reorder(word, n)) %>% ggplot(aes(factor(word), n, fill = n)) + facet_wrap(Artist ~ ., ncol = 2, scales = "free") + geom_col() + xlab(NULL) + coord_flip() + ggtitle("Grunge Artists Word Frequency")
artist.tokens.plot
```

```{R Classic Frequent Terms, echo=FALSE, message=FALSE, warning=FALSE}
classic.tokens.plot <- lyrics.tidy.long %>% unnest_tokens(word, text, drop = FALSE) %>% count(Artist, word, sort = TRUE) %>% anti_join(stop_words) %>% anti_join(tibble(word = c("yeah", "gonna", "0", "hey", "wanna", "2x", "5", "na", "whoo", "1", "2", "3", "7"))) %>% filter(Artist %in% lyrics.selectedArtists[4:7]) %>% group_by(Artist) %>% slice_max(n, n = 10) %>% mutate(word = reorder(word, n)) %>% ggplot(aes(factor(word), n, fill = n)) + facet_wrap(Artist ~ ., ncol = 2, scales = "free") + geom_col() + xlab(NULL) + coord_flip() + ggtitle("Classic Rock Artist Word Frequency")
classic.tokens.plot
```

The same pattern holds with metal artists.

```{R Metal Frequent Terms, echo=FALSE, message=FALSE, warning=FALSE}
metal.tokens.plot <- lyrics.tidy.long %>% unnest_tokens(word, text, drop = FALSE) %>% count(Artist, word, sort = TRUE) %>% anti_join(stop_words) %>% anti_join(tibble(word = c("yeah", "gonna", "0", "hey", "wanna", "2x", "5", "na", "whoo", "1", "2", "3", "7"))) %>% filter(Artist %in% lyrics.selectedArtists[8:10]) %>% group_by(Artist) %>% slice_max(n, n = 10) %>% mutate(word = reorder(word, n)) %>% ggplot(aes(factor(word), n, fill = n)) + facet_wrap(Artist ~ ., ncol = 2, scales = "free") + geom_col() + xlab(NULL) + coord_flip() + ggtitle("Metal Artist Word Frequency")
metal.tokens.plot
```

Even within the same sub-genre, terms have a low correlation with each other. The following plot is composed of grunge terms with a minimum frequency of 150 and a correlation threshold of 0.10.

```{R Grunge Artist Correlation, echo=FALSE, message=FALSE}
artist.dtm <- grunge.corpus %>% VectorSource() %>% Corpus() %>% DocumentTermMatrix()

plot(artist.dtm, terms = findFreqTerms(artist.dtm, lowfreq = 150), corThreshold = 0.10, main = "Grunge Term Correlation Plot (Correlation Threshold of 0.10)")
```

```{R Classic Rock Artist Correlation, echo=FALSE, message=FALSE}
classic.dtm <- classic.corpus %>% VectorSource() %>% Corpus() %>% DocumentTermMatrix()

plot(classic.dtm, terms = findFreqTerms(classic.dtm, lowfreq = 850), corThreshold = 0.10, main = "Classic Rock Term Correlation Plot (Correlation Threshold of 0.10)")
```

```{R Metal Artist Correlation, echo=FALSE, message=FALSE}
metal.dtm <- metal.corpus %>% VectorSource() %>% Corpus() %>% DocumentTermMatrix()

plot(metal.dtm, terms = findFreqTerms(metal.dtm, lowfreq = 275), corThreshold = 0.10, main = "Metal Term Correlation Plot (Correlation Threshold of 0.10)")
```

## Topic Modeling 

As with the genre comparison, all of the grunge artists have large overlaps with each other. However, only one of the artist distinguishes themselves from the others.

```{R Grunge Artist Topics, echo=FALSE, message=FALSE, warning=FALSE}
artist.tidy.united <- lyrics.tidy %>% filter(Artist %in% lyrics.selectedArtists[1:3]) %>% unite(document, Artist, SName)

artist.tidy.words.united <- artist.tidy.united %>% unnest_tokens(word, text, drop = FALSE) %>% count(document, word, sort = TRUE) %>% anti_join(stop_words) %>% anti_join(tibble(word = lyrics.removeWords))


artist.dtm <- artist.tidy.words.united %>% cast_dtm(document, word, n)
artist.lda <- LDA(artist.dtm, k = 3, control = list(seed = 1019))
artist.topics <- tidytext::tidy(artist.lda, matrix = "beta")
artist.topTerms <- artist.topics %>% group_by(topic) %>% top_n(4, beta) %>% ungroup() %>% arrange(topic, -beta)
#artist.topTerms
artist.gamma <- tidytext::tidy(artist.lda, matrix = "gamma")
artist.gamma <- artist.gamma %>% separate(document, c("Artist", "SName"), sep = "_", convert = TRUE)
# artist.gamma

artist.gamma %>% mutate(genre = reorder(Artist, gamma * topic)) %>% ggplot(aes(factor(topic), gamma)) + geom_boxplot() + facet_wrap(~Artist)
```

```{R Classic Rock Artist Topics, echo=FALSE, message=FALSE, warning=FALSE}
classic.tidy.united <- lyrics.tidy %>% filter(Artist %in% lyrics.selectedArtists[4:7]) %>% unite(document, Artist, SName)

classic.tidy.words.united <- classic.tidy.united %>% unnest_tokens(word, text, drop = FALSE) %>% count(document, word, sort = TRUE) %>% anti_join(stop_words) %>% anti_join(tibble(word = lyrics.removeWords))


classic.dtm <- classic.tidy.words.united %>% cast_dtm(document, word, n)
classic.lda <- LDA(classic.dtm, k = 3, control = list(seed = 1019))
classic.topics <- tidytext::tidy(classic.lda, matrix = "beta")
classic.topTerms <- classic.topics %>% group_by(topic) %>% top_n(4, beta) %>% ungroup() %>% arrange(topic, -beta)
#classic.topTerms
classic.gamma <- tidytext::tidy(classic.lda, matrix = "gamma")
classic.gamma <- classic.gamma %>% separate(document, c("Artist", "SName"), sep = "_", convert = TRUE)
# classic.gamma

classic.gamma %>% mutate(genre = reorder(Artist, gamma * topic)) %>% ggplot(aes(factor(topic), gamma)) + geom_boxplot() + facet_wrap(~Artist)
```

```{R Metal Artist Topics, echo=FALSE, message=FALSE, warning=FALSE}
metal.tidy.united <- lyrics.tidy %>% filter(Artist %in% lyrics.selectedArtists[8:10]) %>% unite(document, Artist, SName)

metal.tidy.words.united <- metal.tidy.united %>% unnest_tokens(word, text, drop = FALSE) %>% count(document, word, sort = TRUE) %>% anti_join(stop_words) %>% anti_join(tibble(word = lyrics.removeWords))


metal.dtm <- metal.tidy.words.united %>% cast_dtm(document, word, n)
metal.lda <- LDA(metal.dtm, k = 3, control = list(seed = 1019))
metal.topics <- tidytext::tidy(metal.lda, matrix = "beta")
metal.topTerms <- metal.topics %>% group_by(topic) %>% top_n(4, beta) %>% ungroup() %>% arrange(topic, -beta)
#metal.topTerms
metal.gamma <- tidytext::tidy(metal.lda, matrix = "gamma")
metal.gamma <- metal.gamma %>% separate(document, c("Artist", "SName"), sep = "_", convert = TRUE)
# metal.gamma

metal.gamma %>% mutate(genre = reorder(Artist, gamma * topic)) %>% ggplot(aes(factor(topic), gamma)) + geom_boxplot() + facet_wrap(~Artist)
```

In this comparison chart, a majority of grunge songs are correctly identified with their corresponding artist, however they all have considerable overlap.

```{R Grunge Artist Misclassification, echo=FALSE, message=FALSE, warning=FALSE}
artist.classification <- artist.gamma %>% group_by(Artist, SName) %>% top_n(1, gamma) %>% ungroup()
artist.songTopics <- artist.classification %>% count(Artist, topic) %>% group_by(Artist) %>% top_n(1, n) %>% ungroup() %>% transmute(consensus = Artist, topic)
artist.misclassification <- artist.classification %>% inner_join(artist.songTopics, by = "topic") %>% filter(Artist != consensus)
sort(table(artist.misclassification$Artist), decreasing = TRUE)[1]

artist.assignments <- augment(artist.lda, data = artist.dtm)
artist.assignments <- artist.assignments %>% separate(document, c("Artist", "SName"), sep = "_", convert = TRUE) %>% inner_join(artist.songTopics, by = c(".topic" = "topic"))

artist.assignments %>% count(Artist, consensus, wt = count) %>% group_by(Artist) %>% mutate(percent = n / sum(n)) %>%
  ggplot(aes(consensus, Artist, fill = percent)) + geom_tile() + scale_fill_gradient2(high = "red", label = percent_format()) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, hjust = 1), panel.grid = element_blank()) + labs(x = "Song words were assigned to", y = "Song words came from", fill = "% of assignments")

artist.wrongWords <- artist.assignments %>% filter(Artist != consensus)
```

```{R Classic Rock Artist Misclassification, echo=FALSE, message=FALSE, warning=FALSE}
classic.classification <- classic.gamma %>% group_by(Artist, SName) %>% top_n(1, gamma) %>% ungroup()
classic.songTopics <- classic.classification %>% count(Artist, topic) %>% group_by(Artist) %>% top_n(1, n) %>% ungroup() %>% transmute(consensus = Artist, topic)
classic.misclassification <- classic.classification %>% inner_join(classic.songTopics, by = "topic") %>% filter(Artist != consensus)
sort(table(classic.misclassification$Artist), decreasing = TRUE)[1]

classic.assignments <- augment(classic.lda, data = classic.dtm)
classic.assignments <- classic.assignments %>% separate(document, c("Artist", "SName"), sep = "_", convert = TRUE) %>% inner_join(classic.songTopics, by = c(".topic" = "topic"))

classic.assignments %>% count(Artist, consensus, wt = count) %>% group_by(Artist) %>% mutate(percent = n / sum(n)) %>%
  ggplot(aes(consensus, Artist, fill = percent)) + geom_tile() + scale_fill_gradient2(high = "red", label = percent_format()) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, hjust = 1), panel.grid = element_blank()) + labs(x = "Song words were assigned to", y = "Song words came from", fill = "% of assignments")

classic.wrongWords <- classic.assignments %>% filter(Artist != consensus)
```

Metal artists have considerably less distinction from each other.

```{R Metal Artist Misclassification, echo=FALSE, message=FALSE, warning=FALSE}
metal.classification <- metal.gamma %>% group_by(Artist, SName) %>% top_n(1, gamma) %>% ungroup()
metal.songTopics <- metal.classification %>% count(Artist, topic) %>% group_by(Artist) %>% top_n(1, n) %>% ungroup() %>% transmute(consensus = Artist, topic)
metal.misclassification <- metal.classification %>% inner_join(metal.songTopics, by = "topic") %>% filter(Artist != consensus)
sort(table(metal.misclassification$Artist), decreasing = TRUE)[1]

metal.assignments <- augment(metal.lda, data = metal.dtm)
metal.assignments <- metal.assignments %>% separate(document, c("Artist", "SName"), sep = "_", convert = TRUE) %>% inner_join(metal.songTopics, by = c(".topic" = "topic"))

metal.assignments %>% count(Artist, consensus, wt = count) %>% group_by(Artist) %>% mutate(percent = n / sum(n)) %>%
  ggplot(aes(consensus, Artist, fill = percent)) + geom_tile() + scale_fill_gradient2(high = "red", label = percent_format()) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, hjust = 1), panel.grid = element_blank()) + labs(x = "Song words were assigned to", y = "Song words came from", fill = "% of assignments")

metal.wrongWords <- metal.assignments %>% filter(Artist != consensus)
```



# Conclusion

Based on the above analysis, we can conclude that there are specific differences between sub-genres of rock and roll. Metal is classified by a variety of strongly negative and vulgar terms. However, grunge and classic rock are somewhat similar in this category. The ratio of positive to negative terms for these two genres are roughly equal. Topic modeling paints a different story. It suggests large overlap between metal and grunge in the things discussed in their lyrics. Classic rock stands by itself in terms of the ideas discussed in its music. Artists within a specific genre use similar terminology, however grunge artists write lyrics on unique topics. The same cannot be said for metal artists, as it is almost impossible to determine correctly which artist a particular song belongs to. However, classic rock artists fall somewhere in the middle, as out of the four artists a song typically is assigned mostly to one or two.

Overall, although grunge and classic rock uses similar wording, grunge's lyrics more closely align with heavy metal. Each sub-genre typically has its own set of commonly used terms, and they have a varying degree of originality and uniqueness.


# Citations

